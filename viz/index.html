<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>United States of Emoji</title>
    <style>
    body { margin: 0; padding: 16px; text-align: center; }
    svg { box-sizing: border-box; }
    .state rect { fill: none; }
    .state text { font-size: 10px; font-family: 'Gill Sans'; }
    </style>
  </head>
  <body>
    <div id='viz'></div>
    <script src='//d3js.org/d3.v4.min.js'></script>
    <script>
    const mapWidth = 12
    const mapHeight = 8
    const cellSize = 50
    const margin = 10
    const imgCushion = 10
    const metric = 'tfidf'

    const width = mapWidth * cellSize + margin
    const height = mapHeight * cellSize + margin

    const svg = d3.select('#viz').append('svg')
      .attr('width', width)
      .attr('height', height)

    d3.json('../data/state-stats.json', (error, data) => {
        const stateStats = {}
        data.forEach(d => {
          const stats = d.stats
          stateStats[d.id] = {
            cts: stats.top_counts.map(d => d[0]),
            tfidf: stats.top_tfidf.map(d => d[0])
          }
        })

        const state = svg.append('g')
          .attr('transform', `translate(${margin / 2}, ${margin / 2})`)
          .selectAll('.state')
          .data(data)
          .enter().append('g')
          .attr('class', 'state')
          .attr('transform', d => (
            `translate(${d.grid.x * cellSize}, ${(d.grid.y - 1) * cellSize})`
          ))

        state.append('rect')
          .attr('width', cellSize - 2)
          .attr('height', cellSize - 2)

        state.append('text')
          .attr('class', 'votes')
          .attr('x', cellSize / 2)
          .attr('y', cellSize - 4)
          .style('text-anchor', 'middle')
          .text(d => d.name_short)

        state.append('image')
         .attr('x', imgCushion)
         .attr('y', imgCushion - 4)
         .attr('width', cellSize - (imgCushion * 2))
         .attr('height', cellSize - (imgCushion * 2))
         .attr('xlink:href', d => {
            const emoji = stateStats[d.id][metric][0]
            return `../img/${emoji.replace(/:/g, '').toLowerCase()}.png`;
          })
    })
    </script>
  </body>
</html>
